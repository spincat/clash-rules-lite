name: Update Clash Configuration URLs

on:
  schedule:
    - cron: '0 16 * * *' # Executes at Beijing Time 00:00 (midnight) UTC+8
  workflow_dispatch:

jobs:
  update-clash-config:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Update Proxy Providers Configuration
        run: |
          echo 'Asia/Shanghai' | sudo tee /etc/timezone
          sudo dpkg-reconfigure -f noninteractive tzdata
          # Define path to YAML configuration file
          CONFIG_FILE="clashlink.yaml"
          # Delete existing proxy-providers configurations
          sed -i '/^proxy-providers:/,/^proxy-groups:/d' $CONFIG_FILE
          # Generate proxy-providers configuration for the last 10 days
          echo "proxy-providers:" >> $CONFIG_FILE
          for i in {1..5}; do
            for day_offset in {0..9}; do
              DATE=$(date -d "-$day_offset days" +"%Y%m%d")
              YEAR=$(date -d "-$day_offset days" +"%Y")
              MONTH=$(date -d "-$day_offset days" +"%m")
              if [ $i -le 3 ]; then
                URL="https://www.freeclashnode.com/uploads/$YEAR/$MONTH/$i-$YEAR$MONTH$DATE.yaml"
              else
                # Adjust index for the URL
                IDX=$(expr $i - 3)
                URL="https://apiurl.v1.mk/sub?target=clash&url=https://www.freeclashnode.com/uploads/$YEAR/$MONTH/$IDX-$YEAR$MONTH$DATE.txt&insert=false&config=https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online_Full_NoAuto.ini&emoji=true&list=false&xudp=false&udp=false&tfo=false&expand=true&scv=false&fdn=false&new_name=true"
              fi
              # Concatenate the entry number for uniqueness
              ENTRY_NUM=$((($day_offset * 5) + $i))
              {
                echo "  ðŸ›« æˆ‘çš„æœºåœº $ENTRY_NUM:"
                echo "    type: http"
                echo "    url: \"$URL\""
                echo "    path: ./proxies/airport$ENTRY_NUM.yaml"
                echo "    interval: 43200"
                echo "    filter: \"(?i)æ¸¯|hk|hongkong|hong kong|å°|tw|taiwan|æ—¥æœ¬|jp|japan|æ–°|sg|singapore|ç¾Ž|us|unitedstates|united states|å¡žèˆŒå°”|sc|seychelles|è‹±å›½|uk|united kingdom|æ¾³å¤§åˆ©äºš|au|australia|è¥¿ç­ç‰™|es|spain|é˜¿è”é…‹|ae|united arab emirates|ä¹Œå…‹å…°|ua|ukraine|å¢æ£®å ¡|lu|luxembourg|æ³•å›½|fr|france\""
                echo "    exclude-filter: \"é«˜å€|Ã—10\""
                echo "    health-check:"
                echo "      enable: true"
                echo "      url: https://www.gstatic.com/generate_204"
                echo "      interval: 600"
              } >> $CONFIG_FILE
            done
          done

          # Preserve original content after `proxy-groups`
          awk '/^proxy-groups:/{flag=1} flag' $CONFIG_FILE > temp.yaml
          # Concatenate old proxy-groups and proxy-providers configuration
          cat temp.yaml >> $CONFIG_FILE
          rm temp.yaml
          
          # Commit and push changes
          git config --global user.name 'Spincat'
          git config --global user.email 'miqic911@gmail.com'
          git add $CONFIG_FILE
          git commit -m 'Update proxy-providers configuration' || echo 'No changes to commit'
          git push
